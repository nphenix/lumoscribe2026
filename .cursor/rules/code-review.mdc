---
description: review, code quality, best practices, static analysis, lint, refactor
globs: 
alwaysApply: false
---
---
name: code-review
description: "review, code quality, best practices, static analysis, lint, refactor"
allowed-tools:
  - read_file
  - list_files
  - execute_command
---

# 代码审查器

## 用途

本技能提供AI驱动的代码质量分析和审查能力，包括：
- 识别代码异味和安全漏洞
- 检查编码规范和最佳实践
- 提供改进建议和优化方案
- 生成结构化的审查报告

## 使用时机

在以下情况下调用此技能：
- 需要审查代码变更的质量
- 需要识别潜在的安全风险
- 需要检查代码是否符合项目规范
- 需要提供代码优化建议

## 不使用时机

- 只需要基础的语法检查（使用IDE内置功能）
- 代码不包含业务逻辑
- 已进行过多次审查不需要重复检查

## 工具使用说明

### 命令执行工具

使用命令执行工具执行代码分析命令：

```bash
# 查看文件列表
find . -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java"

# 检查文件语法
python -m py_compile file.py
node -c file.js

# 统计代码行数
wc -l $(find . -type f -name "*.py")
```

### 文件读取工具

使用文件读取工具查看文件内容：

```bash
# 读取待审查文件
读取 src/components/UserProfile.tsx

# 读取项目编码规范
读取 .cursor/rules/constitution.mdc
```

### 文件搜索工具

使用文件搜索工具搜索代码模式和问题：

```bash
# 搜索 TODO 注释
搜索 "TODO|FIXME|HACK"

# 搜索硬编码值
搜索 "\".*\d{3,}.*\"" --file_pattern "*.py"

# 搜索潜在安全问题
搜索 "eval\(|exec\(|os\.system"
```

## 工作流程

### 代码审查流程

1. **收集目标文件**
   - 获取用户指定的文件或目录
   - 支持通配符匹配（如 `*.py`）
   - 默认为整个项目

2. **分析代码结构**
   - 识别主要功能和模块
   - 分析依赖关系
   - 评估代码复杂度

3. **检查编码规范**
   - 命名规范（变量、函数、类）
   - 代码格式（缩进、空行、注释）
   - 文档要求（docstring、注释）

4. **识别问题**
   - 代码异味（过长函数、重复代码）
   - 安全漏洞（注入、认证问题）
   - 性能问题（循环、内存泄漏）
   - 最佳实践违规

5. **生成报告**
   - 按严重程度分类
   - 提供具体位置和建议
   - 总结整体质量

## 审查重点

### 代码质量

| 问题类型 | 描述 | 严重程度 |
|---------|------|---------|
| 重复代码 | 相同的代码片段出现多次 | Warning |
| 过长函数 | 函数代码超过50行 | Warning |
| 魔法数字 | 使用硬编码的数字 | Info |
| 缺少注释 | 关键逻辑没有注释 | Info |

### 安全风险

| 问题类型 | 描述 | 严重程度 |
|---------|------|---------|
| SQL注入 | 使用字符串拼接构建SQL | Critical |
| XSS漏洞 | 未转义的用户输入 | Critical |
| 硬编码密钥 | API密钥或密码在代码中 | Critical |
| 不安全的依赖 | 使用有漏洞的包版本 | Warning |

### 性能问题

| 问题类型 | 描述 | 严重程度 |
|---------|------|---------|
| N+1查询 | 循环中执行数据库查询 | Warning |
| 内存泄漏 | 未释放的资源 | Warning |
| 不必要的循环 | 可以优化的循环逻辑 | Info |

### 架构与规范

| 问题类型 | 描述 | 严重程度 |
|---------|------|---------|
| 目录结构违规 | 不符合 directory-structure.md | Warning |
| Prompt 硬编码 | 业务代码中包含 Prompt 字符串 | Critical |
| Prompt 未注册 | 未在 shared/constants/prompts.py 注册 | Error |
| 依赖管理违规 | 违反 P5 准则 | Warning |


## 输出格式

### 审查报告模板

```
## 代码审查报告

**审查文件**: <文件或目录>
**审查时间**: <时间戳>
**审查范围**: <security|performance|readability|all>

### 审查摘要

- **文件数**: <n>
- **问题数**: <n>
- **严重程度分布**: Critical: <n>, Warning: <n>, Info: <n>

### 发现的问题

#### <文件路径>

##### 1. [严重程度] 问题标题

- **描述**: 问题的详细描述
- **位置**: 第<行号>行
- **问题代码**:
  ```语言
  <代码片段>
  ```
- **建议修复**:
  ```语言
  <修复后的代码>
  ```
- **参考**: <相关规范或最佳实践>

### 改进建议

#### 高优先级
1. <建议1>
2. <建议2>

#### 中优先级
1. <建议3>
2. <建议4>

### 总结

<整体评价和改进方向>
```

## 最佳实践

### 审查原则

- **建设性**: 提供改进建议而非批评
- **具体性**: 指出具体问题和位置
- **一致性**: 遵循项目统一的规范
- **优先级**: 关注严重问题优先

### 常见问题处理

| 问题 | 处理方式 |
|------|---------|
| 代码风格不一致 | 建议使用 linter 自动修复 |
| 缺少测试 | 建议添加单元测试 |
| 文档缺失 | 建议补充 API 文档 |
| 性能瓶颈 | 提供优化方案和性能测试 |

## 注意事项

### 审查范围

- 明确用户指定的审查范围
- 大型项目可以分批审查
- 关注变更相关的文件

### 敏感信息

- 不在报告中暴露敏感代码
- 过滤可能的密钥和凭证
- 保护用户隐私数据

### 团队规范

- 遵循项目的编码规范
- 考虑团队的技术栈和习惯
- 提供可操作的改进建议

## 相关资源

- `speckit/constitution.md` - 项目宪章和质量标准
- `.cursor/rules/constitution.mdc` - Cursor 项目规则
- `speckit/templates/change-template.md` - 变更记录模板

## 版本

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| 1.0.0 | 2026-01-12 | 初始版本，支持代码质量审查 |
| 1.1.0 | 2026-01-12 | 重构为纯Claude Agent Skill格式，使用通用工具描述 |

