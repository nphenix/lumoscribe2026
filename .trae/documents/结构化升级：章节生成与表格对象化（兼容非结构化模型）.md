## 目标（MVP：同时解决图表与表格两类不稳定）
- **图表**：召回更稳定 + 插入位置不漂移（结构化绑定 + 代码落位）。
- **表格**：入库/切分不被破坏（原子性保护）+ 召回后更可推理（Markdown→CSV/JSON 注入）。
- **兼容性**：部分 LLM 不支持工具/函数调用时仍可用（多级降级）。

## 现状对齐（为什么“结构化升级”必要）
- 图表：已存在 chart 独立 chunk + RecursiveRetriever 扩展，但生成仍靠 prompt 约束锚点，导致漂移。
- 表格：默认建库走 STRUCTURE_AWARE；该路径缺乏稳定的 Markdown 表格块识别与原子保护，且 flush 时可能按句末符号切断。

## 关键最佳实践（与本项目的落点一一对应）
- LangChain Structured Output：用 Pydantic schema 把“内容/绑定关系”从文本排版中剥离（参考 https://docs.langchain.com/oss/python/langchain/structured-output ）。
- LlamaIndex 层级检索：对象（图表/表格）适合“摘要索引 + 详情召回”，RecursiveRetriever/AutoMergingRetriever 提供范式（参考：
  - RecursiveRetriever：https://docs.llamaindex.ai/en/stable/examples/query_engine/pdf_tables/recursive_retriever/
  - AutoMergingRetriever：https://docs.llamaindex.ai/en/stable/examples/retrievers/auto_merging_retriever/）。
- Markdown 表格处理：切分阶段必须把表格当作不可拆分块；召回阶段优先给模型 CSV/JSON 以降低列对齐幻觉。

## 方案架构（两条主线并行，互不稀释）
### A. 图表：稳定候选集 + 结构化绑定 + 确定性落位
1) **Chart Candidates Block（提升召回稳定性）**
- 每个 section 生成前构造最多 N=8 的“图表候选集”，来源合并：
  - HybridSearch 命中的段落扩展出的 chart nodes（现有递归逻辑）；
  - 额外一次“chart-only 检索”（metadata filter：chart chunk），query=section 标题 + outline item 关键词。
- 每个候选输出：`chart_id、chart_name、关键结论/指标提示（来自 chart chunk 文本）`，作为独立 block 放进 prompt。

2) **结构化输出 Schema（段落/条目→chart_id 绑定）**
- `SectionStructuredOutput`：`items: list[OutlineItemOutput]`
- `OutlineItemOutput`：`outline_key、markdown_body、chart_bindings`
- `ChartBinding`：`chart_id、attach_to(默认 end_of_item)、why(optional)`

3) **确定性组装（代码负责插入锚点）**
- 代码把 `markdown_body` 以 4 空格缩进插入模板骨架每个 `- x.y` 下。
- 把 `chart_id` 逐个追加到该条目正文末尾（或指定段落后），从根上杜绝“堆到章节末尾”。

4) **图表锚点修复器（结构化失败时保底）**
- 只移动/补齐 `[Chart: id]`，不改正文。
- required_chart_ids 必须全部落位；若集中在末尾，则按“段落文本 vs chart 摘要”相似度移动到最相关条目末尾。

### B. 表格：切分原子保护 + 召回格式升级（CSV/JSON）
1) **结构感知切分补齐“表格块识别与不可拆分”**（MVP 必做）
- 在 STRUCTURE_AWARE 路径增加 Markdown 表格块识别：将表格作为独立 block，标注 `ChunkType.TABLE`。
- 对表格 block 实施“不可拆分”约束：
  - 优先不切；若超 chunk_size：生成“表头+前 N 行+截断提示”的可推理版本作为索引内容，同时保留 raw 表格（详见下一条）。

2) **表格的“摘要索引 + 详情召回”（可选增强，但建议在 MVP 同步做最小版）**
- 为每个表格生成两类节点：
  - `table_summary`（embed 用，短、信息密度高，含 header + 关键行/统计提示）
  - `table_raw`（详情用，保留完整 Markdown/HTML→Markdown）
- 建立 summary↔raw 的链接（metadata 或 parent/child relationship），检索命中 summary 后用 RecursiveRetriever 带出 raw。

3) **召回组装阶段：TABLE 动态转换为 CSV/JSON 注入 Context**
- 生成上下文时，如果 chunk_type==TABLE：
  - 默认注入 CSV（省 token）或 JSON（键值更清晰），并保留一份 raw 作为引用 fallback。
- 这样即使模型不擅长 Markdown 对齐，也能在 CSV/JSON 上做数值对比。

## 兼容性与降级链路（图表+表格共用）
1) 优先尝试 ToolStrategy（tool/function calling）。
2) 失败则退到“JSON 指令 + 解析器”的文本解析模式（PydanticOutputParser 或等价解析）。
3) 仍失败则退到现有纯文本生成：
- 图表：走锚点修复器保底。
- 表格：至少确保 context 注入 CSV/JSON（这一步不依赖模型能力）。
- 所有返回的 `chart_id/table_id` 做白名单校验（必须来自 candidates/检索命中集合）。

## 代码落点（最小侵入、可回退）
- 新增：
  - `SectionStructuredGenerator`（章节结构化生成，复用 `get_model_for_callsite + create_agent + ToolStrategy`）
  - `ChartRetriever`（chart-only 补检索，构造 candidates block）
  - `ChartAnchorPostProcessor`（漂移修复）
  - `TableBlockExtractor`（在 chunking 阶段识别表格并保护）
  - `TableContextFormatter`（Markdown→CSV/JSON）
- 修改：
  - ContentGenerationService：structured 优先 + 自动降级。
  - ChunkingService（STRUCTURE_AWARE）：加入表格块识别与不可拆分策略。
- 新增 Prompt scope（遵循 Prompt Registry）：
  - `content_generation:generate_section_structured`（包含 chart candidates、table formatting 指令）

## 验证与度量（MVP 必须可量化）
- 图表：
  - Chart Recall@K（候选集中包含期望图表比例）
  - Required Coverage（required_chart_ids 全部落位比例）
  - Anchor Drift Rate（锚点集中末尾/错位比例）
- 表格：
  - Table Atomicity（切分后表格未断裂比例）
  - Table Reasoning Pass（用 CSV/JSON 的对比问答正确率，先用小样例回归）
- 兼容性：structured→parser→text 的降级率与失败原因分布。

## 文档更新（brainstorm 文档也要对齐两大重点）
- 把讨论文档改成“图表为主线、表格为并行必做项”，明确：
  - 图表：候选集 + 结构化绑定 + 确定性插入 + 降级修复
  - 表格：切分原子保护 + 召回 CSV/JSON +（可选）摘要索引+递归召回

## 默认执行决策（除非你反对）
- MVP 一次迭代内同时交付：
  - 图表结构化绑定与确定性落位（含降级修复器）
  - 表格切分原子保护 + 召回 CSV/JSON 注入
  - RecursiveRetriever 仅在“对象化 summary↔raw”最小版上启用（避免大范围重构/重建索引）