# 项目章程

## 核心原则

### P1 代码质量守则

- 单个源文件的行数不得超过 2000 行，超出时必须拆分为职责清晰的模块。
- 新增能力必须同步交付自动化单元测试，并通过正式代码评审后方可合入主干。
- **架构质量原则（基于 2025-11-17 重构经验）**:
  - **DRY 原则**: 禁止重复代码。发现重复代码模式时，必须提取为可复用的组件、基类或工具函数。
  - **SOLID 原则**:
    - **单一职责**: 每个类/模块只负责一个明确的功能领域。违反时需拆分为多个职责单一的组件。
    - **开闭原则**: 通过策略模式、适配器模式、工厂模式等设计模式实现扩展，而非修改现有代码。
    - **依赖倒置**: 客户端代码依赖抽象接口（ABC、Protocol），而非具体实现。
  - **设计模式优先**: 在需要扩展性时，优先使用策略模式、适配器模式、工厂模式等，而非硬编码的条件分支。
  - **接口统一**: 同一功能的不同实现必须通过统一接口暴露，使用适配器模式整合。

### P2 目录结构与工件定位

- 必须遵循 [`directory-structure.md`](directory-structure.md) 中定义的目录规范，不允许随意新增顶层目录或模糊命名。
- 任何自动或手动生成的代码/文档都要写入预期路径，禁止散落在临时目录。
- 生成脚本需在输出完成后验证文件是否落在正确位置，否则视为构建失败。
- 命令行执行优先使用 Windows 友好的 PowerShell 命令，同时注意使用 UTF-8 编码。

### P3 临时文件纪律

- 临时脚本、草稿或调试工件只能存在于隔离的工作区，使用完毕立即删除，不得提交到仓库。

### P4 文档与测试管理

- 重大设计决策需在 `docs/` 或 `specs/` 记录理由。
- 架构/API/部署变更必须同步更新对应文档。
- **文档命名规范**：
  - `docs/` 目录下的所有文件必须使用**中文命名**（如 `用户登录流程.md`、`会议纪要-2026-01-15.md`）。
  - 使用 `kebab-case` 或 `sentence-case` 格式。
  - 避免使用英文文件名，保持术语一致性。
- 文档必须使用中文，与代码术语保持一致。
- 文档必须有明确的最后更新时间戳。

| 类型 | 命名 | 存放位置 | 留存策略 |
|------|------|----------|----------|
| **检测脚本** | `check-*.py` | 与功能模块同目录 | 功能变更需同步更新；创建新功能需同步创建；每个功能模块仅一个 |
| **测试脚本** | `test-*.py` | `tests/` | 功能测试 |

### P5 AI助手行为准则

| 场景类型 | 必须确认 | 可自主决策 |
|---------|---------|-----------|
| 删除或重写代码 | 是 | 否 |
| 修改配置文件 | 是 | 否 |
| 添加新依赖 | 是 | 否 |
| 代码格式调整 | 否 | 是 |
| 变量重命名 | 否 | 是 |
| 日志级别修改 | 否 | 是 |

**确认触发条件**:
1. 影响范围超过 3 个文件
2. 涉及 P0/P1 优先级的功能模块
3. 变更涉及 API 的向后兼容性
4. 缺乏明确指令的操作

### P6 错误处理规范

- 所有 API 端点必须有统一的错误响应格式。
- 错误日志必须包含上下文信息（request_id、user_id）。
- 禁止静默吞掉异常（必须记录或重新抛出）。
- 使用自定义异常类，而非通用 Exception。

### P7 日志规范

- 使用结构化日志（JSON 格式）。
- 日志级别: DEBUG < INFO < WARNING < ERROR。
- 关键操作必须记录 INFO 级别日志。
- 禁止在生产环境使用 print() 进行日志输出。
- 日志必须包含足够的上下文信息以便追踪问题。

### P8 禁止模式

- 禁止硬编码配置值。
- 禁止在循环中调用 API。
- 禁止提交 TODO/FIXME 注释。
- 禁止使用 Magic Numbers。
- 禁止直接修改传入的参数。

### P9 交互规范

- **自然语言优先**: 所有与 AI 助手的交互必须使用自然语言描述意图（如"请审查代码"、"生成提交信息"），**严禁**使用斜杠命令（如 `/review`）或 Hash 命令（如 `#git-manager`）。
- **单一事实来源**: `speckit/` 目录是所有规范、模板和技能的唯一事实来源。
- **自动同步**: 对 `speckit/` 的任何修改都必须通过 `scripts/sync-skills.ps1` 脚本同步到工具配置目录（`.cursor/`, `.roo/` 和 `.trae/`）。

### P10 文件说明管理

- 每个目录应包含 `00-目录说明.md` 文件，记录目录内所有文件的用途。
- **创建文件时**：填写文件用途说明，更新对应目录的 `00-目录说明.md`，添加时间戳。
- **更新文件时**：修改用途说明（如有必要），更新时间戳。
- **删除文件时**：从 `00-目录说明.md` 中移除记录，添加删除日志。
- 时间戳格式：`YYYY-MM-DD`。

### P11 提示词管理规范

- **禁止硬编码**: 严禁在业务代码中拼接 Prompt 字符串。
- **Code-First Seed**: 所有 Prompt 必须在 `src/shared/constants/prompts.py` 中定义默认值。
- **Source of Truth**: 运行时必须优先使用数据库中的配置。
- 详见 [`docs/guides/prompt-management-standards.md`](docs/guides/prompt-management-standards.md)。

## 附加约束

- 分层摆放: `src/domain/`、`src/application/`、`src/interfaces/`
- 公共组件放入 `src/shared/` 并附带 README
- 环境: Windows 11、UTF-8、Conda: `lumoscribe2026`
- 沟通语言: 中文

## 模板系统

详见 `CLAUDE.md` 和 `speckit/templates/INDEX.md`:
- 模板选择规则
- 场景匹配指南
- 路径约定
- 工作流程

## 开发工作流程

- **分支命名**:
  - `feature/功能描述`、`fix/问题描述`
  - `release/v版本号`、`hotfix/问题描述`
- 任何代码变更必须同步更新相关文档。
- **重构检查清单**:
  - [ ] 重复代码已提取？
  - [ ] 单一职责已遵守？
  - [ ] 设计模式已使用？
  - [ ] 接口统一？
  - [ ] 错误处理统一？

## 治理

- 本章程优先于其他流程指引。
- 版本规则: MAJOR（删除/重写）、MINOR（新增）、PATCH（澄清）。
- 模板系统详见 `CLAUDE.md` 中的详细说明。

**版本**: 1.6.0 | **批准日期**: 2026-1-11 | **最后修正**: 2026-1-16
